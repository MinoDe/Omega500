<!DOCTYPE html>
<html>
	<head>
		<title>Ω500 Quadtree</title>
		<meta charset="utf-8">
		<link rel="stylesheet" href="../res/main.css">
	</head>
	<body>
		<section>
			<canvas id="board"></canvas>
			<a class="home" href="./">back</a>
		</section>

		<script src="../../build/Ω500.js"></script>

		<script src="../../Ω/utils/QuadTree.js"></script>

		<script>

			var MainScreen = Ω.Screen.extend({

				mode: "quad",

				init: function () {

					Ω.Entity.prototype.isHit = false;
					Ω.Entity.prototype.hit = function () {
						this.isHit = true;
					};
 					Ω.Entity.prototype.render = function (gfx) {
						var c = gfx.ctx;
						c.fillStyle = this.isHit ? "#0f0" : "#999";
						c.fillRect(this.x, this.y, this.w, this.h);
					}

					this.entities = [];
					for (var i = 0; i < 1500; i++) {

						this.entities.push(
							new Ω.Entity(
								Ω.utils.rand(Ω.env.w),
								Ω.utils.rand(Ω.env.h),
								2,
								2
							)
						);

					}

					this.qt = new Ω.utils.QuadTree({x: 0, y: 0, w: Ω.env.w, h: Ω.env.h}, 20, 5);


				},

				tick: function () {

					this.entities.forEach(function (e) {

						e.isHit = false;

						e.x += Math.random() * 2 - 1;
						e.y += Math.random() * 2 - 1;

					});

					if (this.mode === "quad") {

						this.qt.clear();

						this.entities.forEach(function (e) {

							this.qt.insert(e);

						}, this);

						this.entities.forEach(function (e) {

							Ω.Physics.checkCollision(e, this.qt.retrieve(e));

						}, this);

					} else {

						Ω.Physics.checkCollisions(this.entities);

					}

				},

				render: function (gfx) {

					this.clear(gfx, "#000");

					this.qt.render(Ω.gfx);

					this.entities.forEach(function (e) {

						e.render(gfx);

					})

				}

			});

			var game = new (Ω.Game.extend({

				canvas: "#board",

				load: function () {

					this.setScreen(new MainScreen());

				}

			}))(400, 300);

		</script>
	</body>
</html>
