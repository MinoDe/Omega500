<!DOCTYPE html>
<html>
	<head>
		<title>Ω500 A* Pathfinding</title>
		<meta charset="utf-8">
		<link rel="stylesheet" href="../res/main.css">
	</head>
	<body>
		<section>
			<canvas id="board"></canvas>
			<a class="home" href="./">back</a>
		</section>

		<!-- lib files -->
		<script src="../../Ω/Ω.js"></script>
		<script src="../../Ω/utils/base.js"></script>
		<script src="../../Ω/utils/utils.js"></script>
		<script src="../../Ω/utils/Timer.js"></script>
		<script src="../../Ω/input.js"></script>
		<script src="../../Ω/gfx.js"></script>
		<script src="../../Ω/SpriteSheet.js"></script>
		<script src="../../Ω/maps/Map.js"></script>
		<script src="../../Ω/maps/DebugMap.js"></script>
		<script src="../../Ω/screens/Screen.js"></script>
		<script src="../../Ω/Game.js"></script>

		<script src="../../vendor/graph.js"></script>
		<script src="../../vendor/astar.js"></script>
		<script>

			var TitleScreen = Ω.Screen.extend({

				loaded: false,

				init: function () {

					var self = this,
						colMap = {
							"0,0,0,255": 1,
							"71,103,33,255": 2, //WTF?: different values for retina!
							"72,105,33,255": 2
						};

					this.map = new Ω.DebugMap(13, 13, 10, 3);
					this.map.imgToCells("../res/images/level.png", colMap, function (map, entities) {

						console.log(entities)
						var ends = entities["183,123,4,255"];

						// Do some A* path findin'
						var cells = map.cells.map(function (r) {
								// Map the level grid to 1's and 0's
								return r.map(function (c) {
									return c > map.walkable ? 1 : 0;
								});
							}),
							graph = new Graph(cells),
							start = graph.nodes[ends[0][1]][ends[0][0]],
							end = graph.nodes[ends[1][1]][ends[1][0]];

						self.path = astar.search(graph.nodes, start, end);

						self.loaded = true;

					});

				},

				render: function (gfx) {

					var c = gfx.ctx,
						cw = this.map.sheet.w,
						ch = this.map.sheet.h;

					this.clear(gfx, "#000");
					this.map.render(gfx);

					// Draw the path
					if (this.path.length) {
						c.strokeStyle = "#0f0";
						c.beginPath();
						c.moveTo(
							this.path[0].y * cw + cw / 2,
							this.path[0].x * ch + ch / 2
						);
						this.path.slice(1).forEach(function (r) {
							c.lineTo(
								r.y * cw + cw / 2,
								r.x * ch + ch / 2
							);
						});
						c.stroke();
					}

				}

			});

			// Game object
			new (Ω.Game.extend({

				canvas: "#board",

				load: function () {

					this.setScreen(new TitleScreen());

				}

			}))(400, 300);

		</script>
	</body>
</html>
